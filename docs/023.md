# 023. API 文档编写指南

## 技能描述
掌握 API 文档的标准结构、OpenAPI/Swagger 规范、交互式文档生成和最佳实践，编写专业易用的 API 文档。

## 核心知识点

### 1. API 文档的核心要素
- **概述**: API 用途、适用场景、快速开始
- **认证**: 支持的认证方式 (API Key, OAuth2, JWT)
- **端点列表**: 所有可用端点的路径、方法、参数
- **请求/响应示例**: 真实的请求和响应数据
- **错误码**: 所有可能的错误码及含义
- **速率限制**: 请求频率限制和配额
- **版本信息**: API 版本号和弃用策略
- **SDK/客户端**: 官方支持的编程语言客户端

### 2. OpenAPI 规范 (Swagger)
```yaml
openapi: 3.0.3
info:
  title: OpenClaw API
  description: OpenClaw 网关的 REST API
  version: 1.0.0
  contact:
    name: API Support
    email: support@openclaw.ai

servers:
  - url: https://api.openclaw.ai/v1
  - url: http://localhost:18900/v1

paths:
  /messages:
    post:
      summary: 发送消息
      operationId: sendMessage
      tags:
        - Messages
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageRequest'
      responses:
        '200':
          description: 消息发送成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: 请求参数错误
        '401':
          description: 未授权

components:
  schemas:
    MessageRequest:
      type: object
      required:
        - channel
        - message
      properties:
        channel:
          type: string
          description: 目标频道 ID 或名称
          example: "general"
        message:
          type: string
          description: 消息内容
          maxLength: 1000
          example: "Hello, World!"
        reply_to:
          type: string
          description: 回复的消息 ID
          example: "msg_123"
    
    MessageResponse:
      type: object
      properties:
        id:
          type: string
          example: "msg_456"
        status:
          type: string
          enum: [sent, pending, failed]
          example: "sent"
        timestamp:
          type: string
          format: date-time
          example: "2026-02-19T17:00:00Z"
  
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

### 3. 交互式文档工具
- **Swagger UI**: 可视化浏览和测试 API
- **ReDoc**: 美观的三栏布局文档
- **Stoplight Elements**: 现代化 API 文档
- **Postman Collection**: 可导入的 API 集合
- **Insomnia Workspace**: 协作式 API 测试

### 4. 代码示例生成
- **多语言示例**: cURL, Python, JavaScript, Go, Java
- **SDK 自动生成**: 从 OpenAPI 生成客户端库
- **在线沙盒**: 提供可交互的测试环境
- **认证预填充**: 自动填充测试 Token

### 5. 文档维护策略
- **文档即代码**: OpenAPI 文件纳入版本控制
- **CI/CD 集成**: 自动验证和发布文档
- **变更日志**: 记录 API 变更和弃用通知
- **反馈循环**: 收集用户反馈改进文档
- **使用分析**: 跟踪文档访问和搜索关键词

## 实战示例

### 示例 1: 完整的 API 端点文档
```markdown
## 发送消息

**端点**: `POST /api/v1/messages`

发送一条消息到指定的频道或用户。

### 认证
需要 Bearer Token。在 `Authorization` 头中传递:
```
Authorization: Bearer YOUR_JWT_TOKEN
```

### 请求参数

**Headers**:
| 名称 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `Authorization` | string | 是 | Bearer Token |
| `Content-Type` | string | 是 | `application/json` |

**Body**:
| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| `channel` | string | 是 | 目标频道 ID | `"general"` |
| `message` | string | 是 | 消息内容 (最大 1000 字符) | `"Hello!"` |
| `reply_to` | string | 否 | 回复的消息 ID | `"msg_123"` |
| `attachments` | array | 否 | 附件列表 | `[{"url": "..."}]` |

### 请求示例

**cURL**:
```bash
curl -X POST https://api.openclaw.ai/v1/messages \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "channel": "general",
    "message": "Hello from API!",
    "reply_to": "msg_123"
  }'
```

**Python**:
```python
import requests

url = "https://api.openclaw.ai/v1/messages"
headers = {
    "Authorization": "Bearer YOUR_TOKEN",
    "Content-Type": "application/json"
}
data = {
    "channel": "general",
    "message": "Hello from API!",
    "reply_to": "msg_123"
}

response = requests.post(url, json=data, headers=headers)
print(response.json())
```

**JavaScript (Fetch)**:
```javascript
const response = await fetch('https://api.openclaw.ai/v1/messages', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_TOKEN',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    channel: 'general',
    message: 'Hello from API!',
    reply_to: 'msg_123'
  })
});

const result = await response.json();
console.log(result);
```

### 响应

**200 OK**:
```json
{
  "id": "msg_456",
  "status": "sent",
  "timestamp": "2026-02-19T17:00:00Z",
  "channel": "general",
  "message": "Hello from API!"
}
```

**400 Bad Request**:
```json
{
  "error": "invalid_request",
  "message": "Message exceeds maximum length of 1000 characters",
  "details": {
    "field": "message",
    "value": "...(1500 chars)..."
  }
}
```

**401 Unauthorized**:
```json
{
  "error": "unauthorized",
  "message": "Invalid or expired token"
}
```

### 错误码
| 状态码 | 错误码 | 说明 |
|--------|--------|------|
| 400 | `invalid_request` | 请求参数错误 |
| 401 | `unauthorized` | 未授权 |
| 403 | `forbidden` | 无权限访问该频道 |
| 429 | `rate_limited` | 请求频率超限 |
| 500 | `internal_error` | 服务器内部错误 |

### 速率限制
- 普通用户：100 请求/分钟
- 企业用户：1000 请求/分钟
- 超限返回 `429 Too Many Requests`

### 相关接口
- `GET /api/v1/messages/{id}` - 获取消息详情
- `DELETE /api/v1/messages/{id}` - 删除消息
- `GET /api/v1/channels` - 获取频道列表
```

### 示例 2: Swagger UI 部署
```bash
# 使用 Docker 快速部署 Swagger UI
docker run -d \
  -p 8080:8080 \
  -e SWAGGER_JSON=/api/openapi.yaml \
  -v $(pwd)/openapi.yaml:/api/openapi.yaml \
  swaggerapi/swagger-ui
```

访问 `http://localhost:8080` 查看交互式文档。

## 检查清单
- [ ] 编写完整的 OpenAPI 3.0 规范文件
- [ ] 包含所有端点的路径、方法、参数
- [ ] 提供请求和响应的完整示例
- [ ] 定义所有错误码和状态码
- [ ] 说明认证方式和速率限制
- [ ] 生成多语言代码示例 (cURL, Python, JS)
- [ ] 部署交互式文档 (Swagger UI/ReDoc)
- [ ] 提供 SDK 下载或自动生成链接
- [ ] 添加变更日志和版本说明
- [ ] 设置文档反馈入口
- [ ] 集成 CI/CD 自动发布文档

## 常见误区
- ❌ 缺少真实的请求/响应示例
- ❌ 错误码说明不完整或模糊
- ❌ 没有认证和速率限制说明
- ❌ 文档与 API 实现不同步
- ❌ 只提供单一语言的示例
- ❌ 缺少交互式测试功能
- ❌ 没有版本管理和弃用通知

## 参考资料
- [OpenAPI Specification](https://swagger.io/specification/)
- [Swagger Tools](https://swagger.io/tools/)
- [ReDoc](https://redocly.com/)
- [Stoplight](https://stoplight.io/)
- [API Documentation Best Practices](https://readme.com/guides/)
