# 013. RESTful API 高级设计模式

## 技能描述
掌握 RESTful API 的高级设计模式，包括版本控制、分页、过滤、排序和字段选择，提升 API 的灵活性和可维护性。

## 核心知识点

### 1. API 版本控制
- **URI 版本化**: `/api/v1/users`, `/api/v2/users`
- **Header 版本化**: `Accept: application/vnd.api.v1+json`
- **查询参数版本化**: `/api/users?version=1`
- **最佳实践**: 推荐使用 URI 版本化，清晰直观

### 2. 分页策略
- **偏移量分页**: `?page=2&limit=20` (简单，但大数据量性能差)
- **游标分页**: `?cursor=abc123&limit=20` (高性能，适合大数据集)
- **响应元数据**: 返回 `total`, `page`, `has_next` 等信息

### 3. 过滤与排序
- **过滤**: `?status=active&role=admin`
- **多值过滤**: `?status=in:active,pending`
- **排序**: `?sort=-created_at,name` (`-` 表示降序)
- **复合排序**: 支持多字段组合

### 4. 字段选择 (Sparse Fieldsets)
- **包含字段**: `?fields=user:name,email`
- **排除字段**: `?exclude=user:password`
- **嵌套资源**: `?include=posts&fields[posts]=title,content`

### 5. HATEOAS (超媒体驱动)
- 在响应中包含相关资源的链接
- 支持 `self`, `next`, `prev`, `related` 等关系
- 提升 API 的可发现性

## 实战示例

### 示例 1: 分页 + 过滤 + 排序
```bash
GET /api/v1/users?page=2&limit=20&status=active&sort=-created_at
```

响应：
```json
{
  "data": [...],
  "meta": {
    "total": 150,
    "page": 2,
    "limit": 20,
    "has_next": true,
    "has_prev": true
  },
  "links": {
    "self": "/api/v1/users?page=2",
    "next": "/api/v1/users?page=3",
    "prev": "/api/v1/users?page=1"
  }
}
```

### 示例 2: 字段选择
```bash
GET /api/v1/users/123?fields=user:name,email,role
```

响应：
```json
{
  "data": {
    "id": 123,
    "name": "张三",
    "email": "zhangsan@example.com",
    "role": "admin"
  }
}
```

### 示例 3: 嵌套资源展开
```bash
GET /api/v1/users/123?include=posts,comments&fields[posts]=title,created_at
```

## 检查清单
- [ ] 实现 URI 版本控制 (`/api/v1/...`)
- [ ] 支持偏移量或游标分页
- [ ] 提供分页元数据 (`total`, `has_next`)
- [ ] 实现多字段过滤和排序
- [ ] 支持字段选择 (Sparse Fieldsets)
- [ ] 考虑添加 HATEOAS 链接
- [ ] 文档中明确说明所有查询参数

## 常见误区
- ❌ 不分页直接返回全部数据
- ❌ 版本控制混乱 (混用多种方式)
- ❌ 排序参数不统一 (有时用 `order`, 有时用 `sort`)
- ❌ 忽略字段选择，导致响应过大

## 参考资料
- [JSON:API 规范](https://jsonapi.org/)
- [Microsoft REST API Guidelines](https://github.com/microsoft/api-guidelines)
- [Google API Design Guide](https://cloud.google.com/apis/design)
